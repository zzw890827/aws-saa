# EC2

## EC2の特徴

数分で利用可能となる従量課金（時間～秒単位）で利用可能な仮想サーバー

- 起動、ノード追加、削除、マシンスペック変更が数分で可能
- 汎用的なIntelアーキテクチャを採用
- 管理者権限で利用可能
- WindowsやLinuxなどのほとんどのOSをサポート
- OSまでは提供されているタイプを選択することで自動設定され、OSよりのレイヤーを自由に利用可能
- doujinsのAMIにOS設定を作成し、保存して再利用が可能

## インスタンスタイプ

例：t2.nano

- t2：ファミリーと世代
- nano：インスタンスの容量

### インスタンスファミリー

- 汎用：
  - ファミリー：A1、M5、T3など
  - ユースケース：バランスの取れたコンピューティング、メモリ、ネットワークのリソースの提供し、多様なワークロードに使用。ウェブサーバーやコードリポジトリなど、インスタンスのリソースを同じ割合で使用するアプリケーシに最適なインスタンス。
- コンピューティング最適化：
  - ファミリー：C5、C6gなど
  - ユースケース：高いパフォーマンスプロセスが必要なコンピューティングパウンドなアプリケーシに利用。パッチ処理ワークロード、メディアトランスコード、高性能ウェブサーバー、ハイパフォーマンスコンピューティング、科学モデリング、専用ゲームサーバーおよび広告サーバーエンジン、機械学習。
- メモリ最適化：
  - ファミリー：X1、R5、ハイメモリ、z1dなど
  - ユースケース：メモリ内の大きいデータセットを処理するワークロードに対して高速なパフォーマンスに最適なインスタンス。
- ストレージ最適化：
  - ファミリー：H1、D2、I3、I3eなど
  - ユースケース：ローカルストレージの大規模データセットに対する高いシーケンシャル読取および書込みアクセス必要とするワークロード用。ストレージ最適化インスタンスは、数万IOPSもの低レイテンシーなランダムI/Oオペレーションに最適。
- 高速コンピューティング：
  - ファミリー：P3、Inf1、G4、F1など
  - ユースケース：高速コンピューティングインスタンスは、ハードウェアアクセラレータを使用して、浮動小数点計算、グラフィック処理、データパターン照合などの機能を、CPUで実行中のソフトウェアに最適。

### インスタンスは購入方式

- オンデマンドインスタンス：
  - 通常のインスタンス購入方式。
  - 長期契約なしで、コンピューティング性能に対して秒単位で支払う。そのライフサイクルは完全に制御できるため、いつ起動、停止、休止、開始、再起動、または終了するかを決定できる。
- リザーブドインスタンス：
  - 1年または3年の期間利用を予約することで、通常オンデマンド料金に比べて大幅な割引価格適用されるインスタンスの購入形式。
  - 特定のAZまたはリージョンで使用するキャパシティーを予約できる2つのタイプがある。
- スケージュールドリザーブドインスタンス：
  - 1年間にわたり毎日、毎週、または毎月ベースの指定された開始時間および期間で繰り返しキャパシティー予約を購入する。予めキャパシティーを予約しておき、必要な時に使用できるようにする。
  - 接続的には実行されない定期的なスケージュールで実行されるワークロードに利用する。
- スポットインスタンス：
  - オンデマンド価格より定価で利用できるAWS管理用に保持されているが未使用のEC2インスタンス。ユーザは未使用のEC2インスタンスを静止状態割引でリクエストできる
  - 実行時間に柔軟性がある場合、中断できる処理に利用する。

### リザーブドインスタンスの特徴

ユースケース：

- 一定した状態または使用量が予測可能なワークロード
- 災害対策などキャパシティー予約が可能なアプリケーシ

|項目|スタンダード|コンバーティブル|
|----|-------|-------|
|利用期間|1年（40%割引）3年（60%割引）|1年（31%割引）3年（54%割引）|
|AZ/インスタンスサイズ/ネットワークタイプ変更可否|可|可|
|ファミリー/OS/テナンシー/支払いオプション変更可否|否|可|
|リザーブドインスタンスマーケットプレイスでの販売可否|可|今後可能となる予定|

### 物理対応可能なインスタンス

- ハードウェア専有インスタンス
  - 専用HWのVPCで実行されるEC2インスタンス
  - ホストHWのレベルで、他のAWSアカウントに属するインスタンスから物理的に分離する
  - 同じAWSアカウントのインスタンスとはHWを共有する可能性がある。
- Dedicated Host
  - EC2インスタンス容量を完全にお客様専用として利用できる物理サーバー
  - サーバーにバインドされた既存のソフトウェアライセンスを利用可能
- Bare Metal
  - アプリケーションが基盤となるサーバーのプロセッサーとメモリーに直接アクセス可能なインスタンス
  - AWSの各種サービスとの連携が可能でOSが直接下層のハードウェアにアクセス可能

### ストレージの選択

- インスタンスストア：
  - ホストコンピュータに内臓されたディスクでEC2と不可分のブロックレベルの物理ストレージ
  - EC2の一時的なデータが保持され、EC2の停止・終了と共にクリアされる
  - 無料
- EBS：
  - ネットワークで接続されたブロックレベルのストレージでEC2とは独立して管理される
  - EC2を終了してもEBSは保持可能で、SnapshotをS3に保持可能
  - 別途EBS料金が必要

## AMI

### AMIの特徴

- 逆にEC2インスタンスの内容をAMIとしてバックアップ可能
- AMIはリージョンにおいて一意のものであり、他のリージョンでそのまま利用できないが、AMIをほかのリージョンにコピーすることは可能

### AMIの利用

- OSの選択
- EC2のバックアップ
- ゴールデンイメージ
- AMIの共有
- リージョンの移動

## EBS

EC2インスタンスとともに利用されるブロックストレージ。インスタンス上のワークフローなどに利用。

### ストレージの種類

- ブロックストレージ: EBS、インスタンスストア
  - EC2にアタッチして活用するディスクサービス
  - ブロック形式でデータを保存
  - 高速・広帯域幅
- オブジェクトストレージ: S3
  - 安価かつ高い耐久性を持つオンラインストレージ
  - オブジェクト形式でデータを保存
  - デフォルトで複数AZに冗長化されている
- ファイルストレージ: EFS
  - 複数のEC2インスタンスから同時にアタッチ可能な共有ストレージサービス
  - ファイル形式でデータを保存

### インスタンスストアとEBS

- インスタンスストア:
  - ホストコンピュータに内臓されたディスクでEC2と不可分のブロックレベルの物理ストレージ
  - EC2の一時的なデータが保持され、EC2の停止・終了とともにデータがクリアされる
  - 無料
- EBS:
  - ネットワークで接続されたブロックレベルのストレージでEC2とは独立管理
  - EC2を終了してもEBSデータは保持可能
  - スナップショットをS3に保持可能
  - 別途EBS料金が必要

### EBSの特徴

- OSやアプリケーション、データの置き場所など様々な用途で利用される
- 実体はネットワーク接続型ストレージ
- 99.999%の可用性
- サイズは1GB～16TB
- サイズと利用期間で課金
- ボリュームデータはAZ内で複数のHWにデフォルトでレプリケートされており、冗長化不要
- セキュリティグループによる通信制御対象外であり、ぜんポートを閉じてもEBSは利用可能
- データは永続的に保存
- EC2インスタンスは他のAZ内のEBSにはアクセスできない
- EC2インスタンスに複数のEBSを接続することができるが、EBSを複数のインスタンスで共有することはできない
- 但し、プロビジできるョンドIOPSのみ複数インスタンスで共有することが可能となった
- 他のインスタンスに付け替えできる

### SSD

|名称|ユースケース|サイズ|
|----|-------|------|
|汎用SSD|仮想デスクトップ、低レイテンシーを要求するアプリ、小～中規模のデータベース、開発環境|1GB～16TB|
|预配置IOPS|高いI/O性能に依存するNoSQLやあぷり、10,000IOPSや160M/s超のワークロード大規模DB、NitroシステムAmazon EC2インスタンス・EBS最適化インスタンスタイプで高速化|4GB~16TB|

### HDD

|名称|ユースケース|サイズ|
|----|-------|------|
|吞吐优化HDD|ビッグデータ処理、DWH、大規模なETL処理やログ分析、ルートボリューム利用不可|500GB～16TB|
|Cold HDD|ログデータなどアクセス頻度が低いデータ、バックアップやアーカイブ、ルートボリューム利用不可|500GB～16TB|

### スナップショット

- スナップショットでばでナックアップ
- スナップショットからEBS復元する際は別AZにも可能
- スナップショットはS3に保存される
- スナップショットはリージョン間を利用可能

### スナップショットの管理

- スナップショット作成時はデータ整合性を保つため静止点の設定を推奨
- 保存期間や世代数は無制限
- 世代管理が必要な場合はAWS CLIやAPIなどで自動化する
- DLMを利用してスナップショット取得をスケジューリングできる

### スナップショットとAMI

- AMI: EC2インスタンスのOS設定などをイメージとして保持して、新規インスタンス設定に転用するもの
- スナップショット:
  - ストレージ/EBSその時点の断面のバックアップとして保持するもの
  - ストレージの復元や複製に利用

## プレイスメントグループ

- クラスタープレイスメントグループ:
  - 単一AZ内のインスタンスを論理的にグループ化した構成
  - 同じリージョン内の複数のピアノVPCに跨ることも可能
  - グループ内のインスタンスは、TCP/IPトラフィックのフロー当たりのスループット上限が高くなり、ネットワークの二分帯域幅の広い同じセグメントに配置されインスタンス間通信向上する
  - 低いネットワークレイテンシー、高いネットワークスループットを実現するアプリ向けの構成
- パーティションプレイスメントグループ:
  - Amazon EC2は各グループをパーティションと呼ばれる論理的なセグメントに分割した構成
  - プレイスメントグループ内各パーティションにそれぞれ一連のラックがあり、プレイスメントグループ内のパーティション同士が同じラックを共有しない。
  - ラックを分離することで、アプリケーション内でのハードウェア障害による影響を隔離して、軽減する。
- スプレッドプレイスメントグループ:
  - それぞれに独自のネットワークおよび電源がある異なるラックに別々に配置できるインスタンスのグループ
  - 一つのAZ内の、スプレッドプレイスメントグループに配置された七つのインスタンスは、七つの異なるラックに配置される
  - 少数の重要なインスタンスが互いに分離して保持できる。インスタンスが同じラックを共有するときに発生する可能性のある同時障害のリスクを軽減する。
  