# IAM

## IAM概要

- AWS利用者認証の実施
- アクセスポリシーの設定
- 個人またはグループに設定
- 1アカウントでIAMロールを1000まで作成可能
- 1アカウントでAIMグループを300まで作成可能
- 1アカウントでIAMユーザを5000まで作成可能
- IAMユーザは10個のグループまで所属可能

### IAMポリシー

ユーザーなどへのアクセス権限を付与するための設定ドキュメントのこと

```json
{
  "Effect": "Allow",
  "Action": [
    "s3:ListBucket",
    "s3:Get *"
  ],
  "Resource": [
    "arn:aws:s3:::mybucket"
  ],
  "Condition": {
    "IpAddress": {
      "aws:SourceIP": ["192.168.3.4/32"]
    }
  }
}
```

- Effect:
  - Allow: 許可
  - Deny: 拒否
- Action: AWSサービスにどういった操作を許可まだは拒否
- Resource: 対象AWSのリソース（例：Bucket名）
- Condition: アクセス制御が有効となる条件

### IAMユーザー

IAMポリシー内でAWSサービスを利用できるユーザ。

- ルートアカウント（IAMユーザーではない）：
  - AWSアカウント作成時に作られるIDアカウント
  - すべてのAWSサービスとリソースを使用できる権限を有する
  - 日常てきなタスクはルートユーザーを使用しないことが強く推奨される
- 管理者権限（IAMユーザー）：
  - 管理者権限の許可が付与されたIAMユーザーのこと
  - IAMの操作権限まであり
  - ルートアカウントしかできない権限は付与されない
- パワーユーザー（IAMユーザー）：
  - パワーユーザーはIAM以外のすべてのAWSサービスにフルアクセス権限を有するIAMユーザー
  - IAMの操作権限なし

### ルートアカウントしかできない権限

- AWSルートアカウントのメールアドレスやパスワードの変更
- IAMユーザの課金情報へのアクセスに関するactivate/deactivate
- 他のAWSアカウントへのRoute53のドメイン登録の移行
- AWSサービス（サポート等）のキャンセル
- AWSアカウントの停止
- コンソリデイテッドビリング（一括請求）の設定
- 脆弱性診断フォームの提出
- 逆引きDNS申請

### IAMグループ

グループとして権限をまとめて設定された単位のこと。グループには通常は複数のIAMユーザーが設定される。

### IAMロール

AWSリソースに対してアクセス権限をロールとして付与できる。例えば、EC2はIAMロールとしてS3にアクセスする。

### IAMの認証方式

- アクセスキーID/シークレットアクセスキー：
  - EC2インスタンス接続などREST/Query形式
  - AWS CLIやAPI利用時の認証に使用する
- X.509 Certificate：SOAP形式のAPIリクエスト用の認証方式
- AWSマネジメントコンソールのログインパスワード：
  - AWSアカウントごとにパスワードを設定してログイン認証する
  - デフォルトは未設定
- MFA：物理デバイスなどを利用したピンコードによる認証方式

### ユーザーのアクティビティの記録

- IAMアクセスアナライザー：外部エンティティと共有されているS3バケットやIAMろーるなど分析し、セキュリティのリスクであるリソースとデータへの意図しないアクセスを特定
- Access AdvisorのService Last Accessed Data：IAMエンティティが最後にAWSサービスにアクセスした日付と時刻を表示する機能
- Credential Report：利用時などが記録されたIAM認証情報のレポートファイル
- AWS Config：IAMのユーザー、グループ、ロール、ポリシーの変更履歴構成変更を管理・確認することができる機能
- AWS CloudTrail：AWSインフラ全体でアカウントアクティビティをログに記録し、継続的に監視し、保持することができる機能（APIのコールなどを記録することができます）

### IAM権限のベストプラクティス

- AWSアカウントのルートユーザのアクセスキーをロックして通常はルートアカウントを使用しない
- 個々のIAMユーザを作成して、IAMユーザで管理を行う
- IAMユーザへのアクセス許可を割り当てにIAMgグループを利用する
- IAMユーザやIAMグループには最小権限のみを設定する
- 新しくポリシーを作るのではなく、AWS管理ポリシーを使用する
- インラインポリシーではなくカスタマー管理ポリシーを使用する
- アクセスレベルを使用して、IAMアクセス許可を確認する
- ユーザのために強度の高いパスワードポリシーを設定する
- MFAを有効化する
- EC2インスタンスで実行するアプリケーションにはIAMロールを使用する
- 第三者に一時的に認証を付与する場合はIAMロールを使用してアクセス許可を移譲する
- アクセスキーを共有しない
- 認証情報を定期的にローテーションする
- 不要な認証情報の削除する
- AWSアカウントのアクティビティを監視する

## IAM設計

AWSを利用するユーザの役割やアクセス権限を自社の組織構造と併せて設計することが重要

### IAMユーザかIAMグループか

1. 少数利用はIAMユーザを組織利用はIAMグループを設定する。
2. 最小から少人数、今後ユーザーが増える予定があれば、最初からIAMグループを設定する。

### グループ設計

組織別または個人単位にAWS利用者とその役割別の利用範囲を整理して、グループ設計を実施する。

### IAMグループへのポリシー適応

例：

- IAM設計を行う組織は以下通りです：
  - IT管理者：ルートユーザも保持し、権限設定などの責任負っている。
  - 運用管理者：運用管理全般を担っているスタッフで、様々なモニタリングと障害対応などで直接アプリに触れることもある。
  - アプリ開発者：主だったAWSサービスを利用してサービス開発を行っている。
- 権限は以下通りです：
  - IT管理者：フルアクセス権限（MFAが必須）
  - 運用管理者：運用ツール全般と開発環境へのアクセスも付与して、DevOpsに参加できるようにする
  - アプリ開発者：担当しているアプリの開発範囲でのみアクセス権限を付与する。
- 具体的なサービスは以下通りです：
  - IT管理者：管理者ポリシー
  - 運用管理者：ELB、EC2、RDS、S3、Auto-Scaling、VPC、Config、Trail、CloudWatch
  - アプリ開発者：ELB、EC2、RDS、S3、Auto-Scaling、VPC

### IAMロール設計

システム設計からAWSサービス間の連携有無を抽出する。

例：

- システム設計：EC2インスタンスばバッチ処理でS3にデータを保存
- 必要な権限設定：EC2インスタンスにS3へのアクセス権限を設定する

## IAMロールの権限移譲

IAMロールは監査人などに一時的な権限を移譲する際にも利用される。

- IAMロールの権限移譲操作に特化したポリシー
- 当該の信頼ポリシーを関連づけたIAMロールが保有する権限を、信頼ポリシーの操作主体であるPrincipalに移譲することができる。

## Organization

複数のAWSアカウントを利用している場合に、統合管理を実施することができる。

- 複数アカウントの一元管理
- 新規アカウント作成の自動化
- 一括請求
