# Auto Scaling

1. Amazon EC2 Auto Scaling 可帮助您确保拥有正确数量的 Amazon EC2 实例来处理应用程序的负载。
2. 您创建EC2实例的集合，称为自动缩放组，自动为您的实例提供水平缩放（Scale-out），由缩放操作事件触发，启动或终止实例，可用性、成本和系统指标都可以成为扩展的因素。
3. 自动缩放是一种特定区域的服务。
4. 自动缩放可以跨越同一AWS区域内的多个AZ。
5. 可以从控制台、CLI、SDK和API配置自动缩放。
6. 自动扩展没有额外的费用，你只需为所配置的资源（EC2实例）付费。
7. 自动缩放可与ELB、CloudWatch和CloudTrail配合使用。
8. 您可以决定自动缩放将向哪些子网启动新实例。
9. 自动扩展将尝试将EC2实例均匀地分布在AZ上。
10. 启动配置是用于创建新EC2实例的模板，包括实例族、实例类型、AMI、密钥对和安全组等参数。
11. 一旦定义了启动配置，您就无法编辑。
12. 一个启动配置：
    - 可以从AWS控制台或CLI创建。
    - 你可以创建一个新的启动配置，或者您可以使用现有正在运行的 EC2 实例来创建启动配置。
      - AMI必须存在于EC2上。
      - EC2实例标签和实例启动后创建的任何额外的块存储卷将不会被考虑在内。
    - 如果你想改变你的发射配置，你必须创建一个新的配置，进行必要的更改，并与你的自动缩放组一起使用。
13. 您可以使用具有多个自动缩放组（ASG）的启动配置。
14. ASG是由自动扩展策略管理的EC2实例的逻辑分组。
15. 一个ASG一旦被定义，就可以被编辑。
16. 您可以在现有的ASG上附加一个或多个经典ELB。
17. 您可以将一个或多个目标组附加到您的ASG，以包括ALB后面的实例。
18. ELB必须在同一区域。一旦您这样做，ASG 现有或添加的任何 EC2 实例将自动与 ASG 定义的 ELB 注册。
19. 如果向ASG添加实例会导致超过ASG的最大容量，该请求将失败。
20. 如果满足以下条件，您可以向ASG添加一个正在运行的实例。
    - 实例处于运行状态。
    - 用于启动实例的AMI仍然存在。
    - 该实例不是另一个ASG的一部分。
    - 实例是在同一个AZs的ASG。

## 缩放

1. 缩放选项定义了触发器以及何时应供应/取消供应实例。

   | 缩放 | 定义                                       | 应用场景                                                                              |
   |----|------------------------------------------|-----------------------------------------------------------------------------------|
   | 维护 | 保持特定或最低数量的实例运行               | 当您一直能够知道所需要的实例的数量                                                    |
   | 手动 | 使用最大、最小或特定数量的实例              | 当您的需求变化很少，以至于您可以进行手动更改时使用                                     |
   | 计划 | 根据时间表增加或减少实例的数量             | 当你知道你的忙碌和安静的时间时使用。对于确保在非常繁忙的时间之前有足够的实例可用很有用 |
   | 动态 | 基于实时系统指标（如CloudWatch指标）进行扩展 | 基于实例指标进行扩展                                                                  |

2. 缩放选项通过缩放策略进行配置，该策略决定ASG何时、是否以及如何缩放和收缩。

   | 缩放           | 定义                                                            | 应用场景                                                                                                              |
   |--------------|---------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------|
   | 目标跟踪策略   | 缩放策略根据需要增加或删除容量，以使指标保持在或接近指定的目标值 | 一个用例是，您希望将ASG的总CPU使用率保持在70%。                                                                         |
   | 建议缩放策略   | 等到健康检查和冷却期结束后再重新评估                            | 这是一种比较保守的添加/删除实例的方式。在负载不稳定的情况下很有用。Aws推荐在大多数情况下采用阶梯式扩展，而不是简单的扩展 |
   | 阶梯式扩展策略 | 根据一组比例调整（称为阶梯调整）增加或减少ASG的当前容量           | 当您想根据报警漏洞的大小来改变调整时很有用。                                                                           |

## 基于SQS的ASG

1. 也可以基于亚马逊简单队列服务（SQS）队列进行扩展。
2. 使用发送到Amazon CloudWatch的自定义指标，以衡量自动缩放组中每个EC2实例的队列中的消息数量。
3. 然后使用目标跟踪策略，配置您的自动缩放组以根据自定义指标和设定的目标值进行缩放。CloudWatch 警报会调用缩放策略。
4. 使用自定义的 "每个实例的积压 "指标，不仅跟踪队列中的消息数量，而且跟踪可供检索的数量。
5. 可以基于SQS度量 "ApproximateNumberOfMessages"。

## ASG行为和配置

1. EC2自动扩展--终止政策：
   - 终止策略控制在发生scale-in事件时首先终止哪些实例。
   - 默认的终止策略旨在帮助确保您的实例均匀地跨过可用性区以实现高可用性。
   - 默认政策保持通用性和灵活性，以涵盖一系列情况。
2. 您可以定义 "实例保护"，以阻止自动扩展进入并终止实例。
3. 如果自动缩放在一个AZ中启动实例失败，它将尝试其他AZ，直到成功。
4. 默认的健康检查宽限期为300秒。
5. 建议为每个创建的scale-out事件创建一个scale-in事件。
6. 出现不平衡的原因可能是：
   - 手动从配置中删除AZ/子网。
   - 手动终止EC2实例。
   - EC2容量问题。
   - 现货价格达到。
7. Health checks：
   - 默认使用EC2状态检查。
   - 也可以使用ELB健康检查和自定义健康检查。
   - ELB健康检查是在EC2状态检查之外的。
   - 如果任何健康检查返回不健康状态，实例将被终止。
   - 在ELB中，如果ELB将一个实例报告为OutOfService，则该实例被标记为不健康。
   - 一个健康的实例进入InService状态。
   - 如果一个实例被标记为不健康，它将被安排更换。
   - 如果启用了连接耗尽，自动伸扩展等待请求完成或超时后再终止实例。
   - 健康检查宽限期允许新实例在执行健康检查之前有一段时间预热（默认为300秒）。
8. 如果使用ELB，最好启用ELB健康检查，否则EC2状态检查可能会显示一个实例是健康的，而ELB已经确定是不健康的。在这种情况下，实例将被ELB从服务中移除，但不会被Auto Scaling终止。
9. 弹性IP和EBS卷从终止的实例中分离出来，需要手动重新连接。
10. 一旦进入终止状态，EC2实例就不能再投入服务，然而有一个很短的时间段，在这个时间段内，可以运行CLI命令将一个实例改变为健康状态。
11. 与AZ再平衡不同的是，不健康实例的终止是先发生的，然后自动缩放尝试启动新的实例来替换终止的实例。
12. 您可以使用 AWS 控制台或 CLI 从 ASG 中手动删除（分离）实例。
13. 一个实例可以同时连接到一个ASG。
14. 您可以暂停，然后恢复自动缩放组的一个或多个缩放过程。
15. 当您想调查Web应用程序的配置问题或其他问题，然后在不调用缩放进程的情况下对应用程序进行更改时，暂停缩放进程是非常有用的。
16. 您可以手动从ASG中移动一个实例，并使其处于待机状态。
17. 处于待机状态的实例仍由Auto Scaling管理，按正常情况收费，且不计入工作负载/应用使用的可用EC2实例。
18. 自动缩放不会对处于待机状态的实例进行健康检查。
19. 待机状态可用于执行更新/更改/故障排除等，而无需执行健康检查或启动替换实例。
20. 当您删除一个ASG时，实例将被终止。
21. 您可以选择在启动配置中使用Spot实例，并指定竞价价格。
22. 自动扩展将现货实例与按需实例同等对待。
23. 你不能将Spot实例与按需混合。
24. 如果你想改变投标价格，你需要创建一个新的发射配置。
25. 自动缩放可以配置为发送SNS邮件，当：
    - 启动了一个实例。
    - 一个实例被终止。
    - 一个实例无法启动。
    - 一个实例无法终止。
26. 合并ASG
    - 您可以将多个单一AZ自动缩放组合并成一个多AZ自动缩放组。
    - 只能通过使用CLI进行合并。
    - 程序是重新划分其中一个组的区域，以覆盖/跨越其他ASG，然后删除其他ASG。
    - 可在有或无ELB的ASG上进行。
    - 由此产生的ASG必须是预先存在的ASG之一。
27. 冷却时间
    - 冷却时间是自动缩放组的可配置设置，有助于确保它不会在之前的缩放活动生效之前启动或终止其他实例。
    - 当您创建自动缩放组时，会应用默认的冷却时间（300s） 。
    - 您可以在创建自动缩放组时，使用 AWS 管理控制台、create-auto-scaling-group 命令 (AWS CLI) 或 CreateAutoScalingGroup API 操作配置默认的冷却时间。  
    - 自动适用于动态缩放，也可选择适用于手动缩放，但不支持计划缩放。
    - 可以通过缩放特定的冷却时间来覆盖默认的冷却时间。
28. 预热期是指ASG使用阶梯缩放启动的新创建的EC2实例不计入ASG指标的时间段。

## 监控

1. 基本监控每5分钟向CloudWatch发送一次有关ASG实例的EC2指标。
2. 可以启用详细，每1分钟发送一次指标（收费）。
3. 当从控制台创建启动配置时，默认启用EC2实例的基本监控。
4. 当从CLI创建启动配置时，默认启用EC2实例的详细监控。
5. 当您启用自动缩放组指标时，自动缩放每分钟向 CloudWatch 发送采样数据。
6. 配置ASG和EC2监控选项，使它们使用相同的时间段，例如详细监控(EC2)和60秒(ASG)，或基本监控(EC2)和300秒(ASG)。
