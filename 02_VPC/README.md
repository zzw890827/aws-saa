# VPC

## IPアドレスの範囲

IPアドレス＋サブネットマスク＝IPアドレスの範囲

例:
196.51.0.0/16 ➞ 左から16桁目までが同じネットワーク範囲と指定

CIDRによりロック

- /8: **196**.XXX.XXX.XXX
- /16: **196.51**.XXX.XXX
- /24: **196.51.0**.XXX
- /32: **196.51.0.0**

## VPC 概要

AWSクラウド内に論理的に分離されたセクションを作り、ユーザが定義した仮想ネットワークを構築するサービス

- 任意のIPアドレス範囲を選択して仮想ネットワークを構築
- サブネットの作成、ルートテーブルやネットワークゲートウェイの設定など仮想ネットワーク環境を完全に制御可能
- 必要にお応じてクラウド内外のネットワーク同士を接続することも可能
- 複数の接続オプションが利用可能
  - インターネット経由
  - VPN/Direct Connect

### VPCの設定

AWSアカウントを作成すると、自動的に各リージョンに１つずつデフォルトVPCとVPCデフォルトサブネットが生成される。

- サイズ/16のIPv4 CIDRブロックのVPCを生成する。これは最大65535個のプライベートIPv4アドレスを提供する。
- 各AZにサイズ/20のデフォルトサブネット作成する。この場合は、サブネット当たり最大4096個アドレスが作成され、その中行いくかはAmazonが使用するようによやくされる。
- インターネットゲートウェイを作成して、デフォルトVPCに接続する。
- デフォルトのSGを作成し、デフォルトVPCに関連付ける。
- デフォルトのACLを作成し、デフォルトVPCに関連付ける。
- デフォルトVPCを備えたAWSアカウントにはデフォルトDHCPオプションを関連付ける。
- パブリックとプライベートのDNSホスト名が付与される。

### CIDR

VPCは/16から/28のCIDR範囲を使用できる。

- 設定できないアドレス（/24）
  - .0: ネットワークアドレス
  - .1: VPCルータ
  - .2: Amazonが提供するDNSサービス
  - .3: AWSで予約されているアドレス
  - .255: ブロードキャストアドレス

### VPC設計ポイント

- 設計時に将来の拡張も見据えたアドレッシングや他ネットワークとの接続性も考慮する。
- CIDRは既存のVPC、社内のDCやオフィスと被らないアドレス帯を設定し、組織構成やシステム構成の将来像も考えながら前もって計画する。
- VPC構成は自社業務に合わせたVPC単体ではなくVPC全体の関係性も視野に入る。
- 組織とシステム境界からVPCをどのように分割する将来構成も考慮して検討する。
- 複数AZを利用して可用性の高いシステムを構築。
- サブネットは大きいサブネットを使い、パブリック/プライベートサブネットへのリソースの配置をインターネットアクセス可否から検討する。
- セキュリティグループを使ってリソース間のトラフィックを適切に制御する。
- 実装や運用を補助するツールも有効利用し、VPC Flow Logsを使ってモニタリングできるようにする。

## セキュリティグループとACL

- セキュリティグループ: インスタンスへのトラフィックのアクセス可否を設定するファイアウォール機能を提供。
- ACL: サブネットに対するトラフィック制御を実施する。

### 比較

| セキュリティグループ | ACL |
|--------------------|-----|
|サーバ単位で適用 |VPC/サブネット単位で適用 |
|インバウンドのみ設定すればアウトバウンドも許可される |インバウン設定だけではアウトバウンドは許可されない
|許可のみIn/Outで指定|許可と拒否をIn/Outで指定|
|デフォルトでは同じセキュリティグループ内通信のみ許可|デフォルトでは全ての通信を許可する設定|
|全てのルールを適応|番号の順番通りに適用|

## VPCとの接続

### VPCとのオンプレミス接続

1. VPN
2. Direct Connect

### Direct Connect

お客様のデータセンターやオフィスを専用線などを介してAWSへプライベートに接続するサービス。

- メリット
  - 安価なアウトバウンドトラフィック料金
  - ネットワーク信頼性の向上
  - ネットワーク帯域幅の向上

Direct Connect Gatewayにより、同一アカウントに所属する複数リージョンの複数AZから複数リージョンの複数VPCに接続。

### VPNとDirect Connect

| Item  |VPN|Direct Connect|
|---|---|---|
|コスト|安価なベストエフォート回線が利用可能|キャリアの専用線サービス契約が必要となりVPNより割高|
|リードタイム|クラウド上での接続設定で可能なため即時|物理対応が必要なため数週間|
|帯域幅|暗号化のオーバーヘッドにより制限がある|ポートあたり1G/10Gbps|
|品質|インターネット経由のためネットワーク状態の影響を受ける|キャリアにより高い品質が保証される|
|障害切り分け|インターネットベースのため自社で保持している範囲以外の確認は難しい|物理的に経路が確保されているため比較的容易|

### VPCエンドポイント

VPCエンドポイントはグローバルIPを持つAWSサービスに対して、VPC内から直接アクセスするための出口

- Gateway型はサブネットに特殊なルーティングを設定し、VPC内部から直接外のサービスと通信する、DynamoDBとS3だけ使える。他のサービスはInterface型。
  - アクセス制御: エンドポイントポリシーを設定
  - 料金: 無料
  - 冗長性: AWS側が対応
- PrivateLink型はサブネットにエンドポイント用のプライベートIPアドレスを生成し、DNSが名前解決でルーティングする
  - アクセス制御: セキュリティグループを設定
  - 料金: 有料
  - 冗長性: マルチAZ設計

### VPC FLow Logs

ネットワークトラフィックを取得し、CloudWatchでモニタリングできるようにする機能

- ネットワークインターフェースを送信元とするトラフィックが対象
- セキュリティグループとネットワークACLのルールaccepted/rejectされたトラフィックログを取得
- キャプチャウィンドウといわれる時間枠で収集・プロセッシング・保存する
- RDS、Redshift、ElasticCache、WorkSpacesのネットワークインターフェーストラフィックも取得可能
- 追加料金はなし

### VPCの設定上限

1. リージョンあたりVPCの上限数: 5
2. VPC当たりのサブネットの上限数: 200
3. AWSアカウント当たりの1リージョン内のElasticIP数: 5
4. ルーティング当たりのルート上限数: 100
5. VPC当たりのセキュリティグループの上限数: 500
6. セキュリティグループ当たりのルールの上限数: 50

### VPCを分割するケース

1. アプリケーシによる分割
2. 監査のスコープによる分割
3. リスクレベルによる分割
4. 本番/検証/開発フェーズによる分割
5. 部署による分割し、共通サービスの切り出し

### VPC Peering

VPC Peeringにより二つのVPC間でのトラフィックルーティングが可能

1. 異なるAWSアカウント間のVPC間をピア接続可能
2. 一部のリージョン間の異なるVPC間のピア接続も可能
3. 単一障害点や帯域幅のボトルネックは存在しない
